import { Injectable } from '@angular/core';
import { HttpClient, HttpErrorResponse } from '@angular/common/http';
import { Observable, throwError } from 'rxjs';
import { catchError, tap } from 'rxjs/operators';
import { AuthResponse } from '../interfaces/auth-response.interface';
import { ActivatedRoute, NavigationEnd, NavigationStart, Router } from '@angular/router';

@Injectable({
  providedIn: 'root'
})

/*
{
    "responsiblePerson": {
        "nameEn": "test",
        "nameAr": "test",
        "titleEn": "test",
        "titleAr": "test",
        "email": "test@test",
        "phone": "1234567989"
    },
    "registrationNumber": "data:image/jpeg;base64,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",
    "nameEn": "test",
    "nameAr": "تست",
    "email": "test@test",
    "password": "123456",
    "rePassword": "123456",
    "phone": "000000"
}
*/

export class AuthService {
  constructor(private http: HttpClient, private router: Router, private activatedRoute: ActivatedRoute) { }

  logIn(formValue: any) {
    return this.http.post<AuthResponse>(
      'http://abdelmageed-001-site15.etempurl.com/api/Accounts/Login', formValue).pipe(catchError(this.handleError), tap(resData => {
        localStorage.setItem('token', resData.token)
        localStorage.setItem('refreshToken', resData.refreshToken)
      }))
  }

  signUp(formValue: any) {
    return this.http.post('http://abdelmageed-001-site15.etempurl.com/api/Accounts/Register', formValue)
      .pipe(catchError(this.handleError), tap(resData => {
        // this.router.navigate(['/auth/login'])
      }))
  }

  getAuthToken(): string {
    return localStorage.getItem('token') || ''
  }

  autoLogin() {
    if (!localStorage.getItem('token')) {
      // this.logout()
      // } else {
      //   this.router.navigate([''])
    }
  }

  logout() {
    localStorage.clear()
    this.router.navigate(['/auth/login'])
  }

  isTokenExpired(): boolean {
    // const token = localStorage.getItem('token') || '';
    // const expiry = (JSON.parse(atob(token.split('.')[1]))).exp;
    // return Date.now() > expiry * 1000;
    return false
  }

  postFile(formData: FormData) {
    return this.http.post('http://localhost:4000/api/create-user', formData)
  }

  private handleError(errorRes: HttpErrorResponse) {
    let errorMessage = "an unknown error occurred!";
    if (!errorRes.error || !errorRes.error.error) {
      return throwError(errorMessage)
    }
    switch (errorRes.error.error.message) {
      case 'EMAIL_EXISTS':
        errorMessage = 'This email exists already';
        break;
    }
    return throwError(errorMessage)
  }

}
